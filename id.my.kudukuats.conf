server {
        listen 80;
        #listen [::]:80;

        server_name kudukuats.my.id;

        return 301 https://www.kudukuats.my.id$request_uri;
}

server {
        listen 80;
        #listen [::]:80;

        server_name www.kudukuats.my.id;

        access_log /var/www/id.my.kudukuats/logs/access.log;
        error_log /var/www/id.my.kudukuats/logs/error.log;

        return 301 https://www.kudukuats.my.id$request_uri;
}

server {
        listen 443 ssl;
        #listen [::]:443 ssl;

        server_name kudukuats.my.id;

        ssl_certificate /etc/nginx/cloudflare-ca/my.id.kudukuats/fullchain.pem;
        ssl_certificate_key /etc/nginx/cloudflare-ca/my.id.kudukuats/privkey.pem;

        access_log /var/www/id.my.kudukuats/logs/access.log;
        error_log /var/www/id.my.kudukuats/logs/error.log;

        return 301 https://www.kudukuats.my.id$request_uri;
}

server {
        listen 443 ssl;
        #listen [::]:443 ssl;

        server_name www.kudukuats.my.id;

        ssl_certificate /etc/nginx/cloudflare-ca/my.id.kudukuats/fullchain.pem;
        ssl_certificate_key /etc/nginx/cloudflare-ca/my.id.kudukuats/privkey.pem;

        access_log /var/www/id.my.kudukuats/logs/access.log;
        error_log /var/www/id.my.kudukuats/logs/error.log;

        location /_next/image {
                proxy_pass http://127.0.0.1:9900;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;

                more_clear_headers "Cache-Control";
                more_set_headers "Cache-Control: public, max-age=2592000";
                proxy_cache my_image_cache;
                proxy_cache_valid 200 30d;
                proxy_cache_use_stale error timeout updating;
                add_header X-Proxy-Cache $upstream_cache_status;

                proxy_cache_lock on;
                proxy_cache_lock_timeout 10s;

                proxy_hide_header X-Nextjs-Cache;
                proxy_hide_header X-Nextjs-Prerender;
                proxy_hide_header X-Nextjs-Stale-Time;
                proxy_hide_header Vary;

                add_header X-Powered-By "kudukuats.my.id";
        }

        location /static {
                proxy_pass http://127.0.0.1:9900;
                proxy_set_header Host $host;

                more_clear_headers "Vary";
                more_clear_headers "Set-Cookie";
                more_clear_headers "Cache-Control";

                # Set header cache statis
                more_set_headers "Cache-Control: public, max-age=31536000, immutable";
                etag off;

                proxy_hide_header X-Nextjs-Cache;
                proxy_hide_header X-Nextjs-Prerender;
                proxy_hide_header X-Nextjs-Stale-Time;
                proxy_hide_header Vary;

                add_header X-Powered-By "kudukuats.my.id";
        }

        location /video {
                proxy_pass http://127.0.0.1:9900;
                proxy_http_version 1.1;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection 'upgrade';
                proxy_set_header Host $host;

                add_header Cache-Control "public, max-age=31536000, immutable";
                etag off;

                proxy_hide_header X-Nextjs-Cache;
                proxy_hide_header X-Nextjs-Prerender;
                proxy_hide_header X-Nextjs-Stale-Time;
                proxy_hide_header Vary;

                add_header X-Powered-By "gundo.cc";
        }

        location / {
                proxy_set_header CF-Connecting-IP $http_CF_Connecting_IP;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $remote_addr;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Host $http_host;

                proxy_pass http://127.0.0.1:9900/;

                proxy_hide_header X-Nextjs-Cache;
                proxy_hide_header X-Nextjs-Prerender;
                proxy_hide_header X-Nextjs-Stale-Time;
                proxy_hide_header Vary;

                add_header X-Powered-By "kudukuats.my.id";
        }
}
